顺便说一下，有一个记忆技巧可以帮助你记住哪些情况用地板，哪些情况用天花板：半开区间如果包含左端点但不包含右端点（比如 $0\le\theta < 1$），比包含右端点但不包含左端点的区间稍微多一些；而地板比天花板稍微多一些。因此，根据墨菲定律，正确的规则与我们预期的恰恰相反——对于 $[\alpha\cdots \beta)$，用 $ceil$；而对于 $(\alpha\cdots \beta)$，用 $floor$。

类似分析表明，闭区间 $[\alpha\cdots \beta]$ 恰好包含 $\lfloor\beta\rfloor−\lceil\alpha\rceil+1$ 个整数，而开区间 $(\alpha\cdots \beta)$ 包含 $\lfloor\beta\rfloor−\lceil\alpha\rceil-1$；但我们对后者施加了额外的限制 $\alpha\ne\beta$，以避免该公式因声称空区间 $(\alpha\cdots \alpha)$ 总共包含 −1 个整数而令人尴尬。总而言之，我们推导出了以下事实：
```math
\begin{aligned}
区间 &\qquad 包含的整数 &\qquad 限制 \\
[\alpha\cdots \beta] &\qquad \lfloor\beta\rfloor−\lceil\alpha\rceil+1 &\qquad \alpha\le \beta, \\
[\alpha\cdots \beta) &\qquad \lfloor\beta\rfloor−\lceil\alpha\rceil &\qquad \alpha\le \beta, \\
(\alpha\cdots \beta] &\qquad \lfloor\beta\rfloor−\lceil\alpha\rceil &\qquad \alpha\le \beta \\
(\alpha\cdots \beta) &\qquad \lfloor\beta\rfloor−\lceil\alpha\rceil-1 &\qquad \alpha< \beta     \tag{3.12}
\end{aligned}
```

现在，我们遇到了一个无法拒绝的问题。具体数学俱乐部拥有一家赌场（仅限购买本书的读者开放），赌场里有一台轮盘，共有一千个槽位，编号从 $1$ 到 $1000$。如果某次旋转出现的数字 $n$ 能被其立方根的整数部分整除，也就是说，如果
```math
\lfloor\sqrt[3]{n}\rfloor \backslash n,
```

那么，这就算赢了，庄家付给我们 $5$ 美元；否则，就算输了，我们必须付 $1$ 美元。（符号 $a\backslash b$，读作“$a$ 整除 $b$”，表示 $b$ 是 $a$ 的整数倍；第4章将仔细研究这种关系。）如果我们玩这个游戏，能指望赚钱吗？

我们可以计算平均赢利，也就是每次游戏我们能赢（或输）的金额，首先统计一下赢家的数量 $W$ 和输家的数量 $L = 1000 − W$。如果在 $1000$ 次游戏中每个数字都出现一次，我们赢 $5W$ 美元，输 $L$ 美元，那么平均赢利将是
```math
\frac{5W - L}{1000} = \frac{5W - (1000 - W)}{1000} = \frac{6W - 1000}{1000}
```

如果有 $167$ 名或更多获胜者，我们占优势；否则，优势在庄家。

我们如何统计从 $1$ 到 $1000$ 之间的获胜者数量呢？不难发现其中的规律。从 $1$ 到 $2^3 − 1 = 7$ 的所有数字都是获胜者，因为对于每个数字，$\lfloor\sqrt[3]{n}\rfloor = 1$ 都成立。在 $2^3 = 8$ 到 $3^3 − 1 = 26$ 这些数字中，只有偶数才是获胜者。而在 $3^3 = 27$ 到 $4^3 − 1 = 63$ 之间，只有能被 $3$ 整除的数字才是获胜者。以此类推。

若运用第 2 章的求和技巧，并借助艾弗森约定（逻辑命题的取值为 0 或 1），我们便可对整套构造进行系统的分析：
```math
\begin{aligned}
W &= \sum_{n=1}^{1000} [n\ is\ a\ winner] \\
  &= \sum_{1\le n\le 1000} [\lfloor\sqrt[3]{n}\rfloor \backslash n] \\
  &= \sum_{k, m}[k=\lfloor\sqrt[3]{n}][k\backslash][1\le n\le 1000] \\
  &= 1 + \sum_{k, m}[k^3\le km<(k+1)^3][1\le k\le 10] \\
  &= 1 + \sum_{k, m}[m\in [k^2\cdots (k+1)^3/k]][1\le k\le 10] \\
  &= 1 + \sum_{1\le k\le 10}(\lceil k^2+3k+3+1/k\rceil - \lceil k^2\rceil) \\
  &= 1 + \sum_{1\le k\le 10}{3k+4} = 1 + \frac{7 + 31}{2}\cdot 9 = 172
\end{aligned}
```

这一推导值得仔细研究。请注意，第6行使用了我们公式（3.12）来计算半开区间中的整数个数。唯一“棘手”的步骤是第 3 行与第 4 行之间作出的决定：将 $n=1000$ 视作一种特殊情况。（当 $k=10$ 时，不等式 $k^3\le n＜(k+1)^3$ 与 $1\le n\le 1000$ 难以直接合并。）一般来说，边界条件往往是处理过程中最为关键的部分。

底线表明，$W=172$ ；因此，我们每局平均赢利的计算公式简化为：$(6.172-1000)/1000$ 美元，即 $3.2$ 美分。如果我们每局下注 $1$ 美元，共下 $100$ 局，那么预计可多赚约 $3.20$ 美元。（当然，庄家可能对某些数字进行了更均匀的设置。）

我们刚刚解决的赌场问题，其实是对一个更为平淡无奇的问题——在 $1\le n\le 1000$ 之间，有多少个整数满足关系 $\lfloor\sqrt[3]{n}\rceil\backslash n$？——的一种包装升级版。从数学角度来看，这两个问题本质上是相同的。但有时候，对问题进行适当包装反而是个好主意。这样一来，我们可以使用更多专业术语（比如“赢家”和“输家”），这有助于我们更深入地理解问题的本质。

让我们来探讨一下一般情况。假设我们将 $1000$ 改为 $1000000$，或者改为更大的数字 $N$。（我们假定赌场有关系，能够获得一个更大的转盘。）那么，现在有多少位赢家呢？

同样的论点同样适用，但我们需要更谨慎地处理k的最大值，为方便起见，我们可以将其称为 $K$：
```math
k = \lfloor\sqrt[3]{n}\rceil.
```

此前 K 为$10$。一般 $N$ 的获奖者总数为：
```math
\begin{aligned}
W &= \sum_{1\le k< K}(3k+4) + \sum_m[K^3\le Km\le N]  \\
  &= \frac{1}{2}(7+3K+1)(K-1) + \sum_m[m\in [k^2..N/K]] \\
  &= \frac{3}{2}k^2 + \frac{5}{2}K - 4 + \sum_m[m\in [k^2..N/K]].
\end{aligned}
```

我们知道，剩余的和为 $\lfloor N/K\rfloor - \lceil k^2\rceil + 1= \lfloor N/K\rfloor - k^2 + 1$，因此该公式成立。
```math
W = \lfloor N/K\rfloor + \frac{1}{2}K^2 + \frac{5}{2}K - 3, K=\lfloor \sqrt[3]{N}\rfloor \tag{3.13}
```

给出了尺寸为N的轮子的一般答案。

该公式前两项约为 $N^{2/3}+\frac{1}{2}N^{2/3} =\frac{3}{2}N^{2/3}$，而其他各项相比之下要小得多，尤其是在 $N$ 较大时。在第9章中，我们将学习如何推导出类似这样的表达式。
```math
W = \frac{3}{2}N^{2/3} + O(N^{1/3})
```

其中，$O(N^{1/3})$ 表示一个量，其值不超过常数与 $N^{1/3}$ 的乘积。无论这个常数是多少，我们都知道它与 $N$ 无关；因此，对于较大的 $N$ 而言，$O$ 项对 $W$ 的贡献将远小于 $N^{2/3}$。例如，下表展示了 $N^{2/3}$ 与 W 的接近程度：
| N | $\frac{3}{2}N^{2/3}$ | W | 误差 |
| --: | --: | --: | --: |
1,000 | 150 | 172 | 12.79
10,000 | 696.2 | 746 | 6.67
100,000 | 3231.7 | 3343 | 3.331
1,000,000 | 15000.0 | 15247 | 1.620
10,000,000 | 69623.9 | 90158 | 0.761
100,000,000 | 323165.2 | 344322 | 0.357
1,000,000,000 | 1500000 | 1502496 | 0.166

这是一个相当不错的近似值。

近似公式之所以实用，是因为它们比包含下取整、上取整的公式更简洁。然而，精确结果往往也很重要，尤其对于实际应用中经常出现的较小 $N$ 值而言。举个例子：赌场老板可能会错误地认为，当 $N = 1000$ 时，赢家只有 $\frac{3}{2}N^{2/3} = 150$ 人（这种情况下，庄家每注可赚取 $10$ 美分的优势）。

本节的最后一个应用，我们来看所谓的谱（spectrum）。我们将实数 x 的谱定义为整数构成的无限多重集，
```math
Spec(\alpha) = \{\lfloor\alpha\rfloor, \lfloor 2\alpha\rfloor, \lfloor 3\alpha\rfloor, \cdots \}
```

多重集与集合类似，但允许元素重复出现。例如，$1/2$​ 的谱的前几项为 $\{0,1,1,2,2,3,3,\cdots\}$。

不难证明没有两个不同的实数会拥有相同的谱—— 也就是说，$\alpha\ne\beta$ 当且仅当 $Spec(\alpha)\ne Spec(\beta)$。证明如下：不妨设 $\alpha<\beta$，则存在正整数 $m$ 使得 $m(\beta−\alpha)\ge 1$。（事实上，任意满足 $m\ge \lceil\beta−\alpha\rceil$ 的 $m$ 都可以；不过我们也不必时时刻刻都炫耀自己对上下取整函数的掌握。）于是有 $m\beta−m\alpha\ge 1$，进而 $\lfloor m\beta\rfloor>\lfloor m\alpha\rfloor$。因此， $Spec(\beta)$ 中 $\le \lfloor m\alpha\rfloor$ 的元素个数少于 $m$ 个，而 $Spec(\alpha)$ 中这样的元素至少有 $m$ 个。

谱 (Spectra) 具有许多优美的性质。例如，我们来考察如下两个多重集：
```math
Spec(\sqrt{2}) = \{1,2,4,5,7,8,9,11,12,14 \} \\
Spec(2 + \sqrt{2}) = \{3,6,10,13,17,20,23,27,30,34 \}
```

用普通计算器就能轻松算出 $Spec(\sqrt{2}​)$，并且由式 (3.6) 可知，$Spec(2+\sqrt{2}​)$ 的第 $n$ 项恰好比 $Spec(\sqrt{2}​)$ 的第 $n$ 项大 $2n$。进一步观察会发现，这两个谱之间还存在一种更为惊人的关联：一个谱中缺失的数，总会出现在另一个谱中，且没有任何数会同时出现在两个谱里！这一结论是成立的：全体正整数恰好是 $Spec(\sqrt{2}​)$ 与 $Spec(2+\sqrt{2}​)$​) 的不相交并。我们称这样的一对谱构成了正整数集的一个*划分*。

为证明这一断言，我们来统计：$Spec(\sqrt{2}​)$ 中不大于 $n$ 的元素个数，以及 $Spec(2+\sqrt{2}​)$ 中不大于 $n$ 的元素个数。若对每个正整数 $n$，这两个数之和恰好等于 $n$，则这两个谱确实构成了正整数集的划分。

设正实数 $\alpha>0$，则 $Spec(\sqrt{\alpha}​)$ 中不大于 n 的元素个数为:
```math
\begin{aligned}
N(\alpha, n) &= \sum_{k>0}[\lfloor k\alpha\rfloor\le n]  \\
             &= \sum_{k>0}[\lfloor k\alpha\rfloor< n+1]  \\
             &= \sum_{k>0}[k\alpha< n+1]  \\
             &= \sum_k[0<k<(n+1)/\alpha]  \\
             &= \lceil(n+1)/\alpha\rceil - 1  \tag{3.14}
\end{aligned}
```

这个推导有两个特别值得关注的点。首先，它使用了该定律
```math
m\le n \iff m < n+1, integers\ m\ and\ n \tag{3.15}
```

将 $\le$ 改为 $<$,以便能够通过(3.7)去掉括号。另外，这一点更微妙，它对范围 $k > 0$ 求和，而不是对 $k\ge 1$ 求和，因为 $(n + 1)/\alpha$ 对于某些 $n$ 和 $\alpha$ 可能小于 $1$。如果我们试图应用(3.12)来确定 $[1..(n + 1)/\alpha]$ 中的整数个数，而不是 $(0..(n + 1)/\alpha)$ 中的整数个数，我们本会得到正确的答案；但我们的推导过程会有问题，因为适用条件并未满足。

我们有了一个公式 $N(\alpha, n)$。现在，我们可以通过检验 $N(\sqrt{2}, n)$ + $N(2+\sqrt{2}, n)$ 是否等于 $n$ 来判断 $Spec(\sqrt{2}​)$ 和 $Spec(2+\sqrt{2}​)$ 是否将正整数进行了划分，其中 $n$ 是所有大于 $0$ 的整数，使用 (3.14):
```math
\lceil\frac{n+1}{\sqrt{2}}\rceil -1 + \lceil\frac{n+1}{2+\sqrt{2}}\rceil -1 = n \\
\iff \lfloor\frac{n+1}{\sqrt{2}}\rfloor + \lfloor\frac{n+1}{2+\sqrt{2}}\rfloor = n, \qquad by (3.2)\\
\iff frac{n+1}{\sqrt{2}} - \{\frac{n+1}{\sqrt{2}}\}  + frac{n+1}{2+\sqrt{2}} - \{\frac{n+1}{2+\sqrt{2}}\} = n, \qquad by (3.8)
```

现在一切都变得简单了，因为有了这个简洁的标识。
```math
frac{1}{\sqrt{2}} + \frac{1}{2 + \sqrt{2}} = 1,
```

我们的条件归结为测试是否
```math
\{\frac{n+1}{\sqrt{2}}\}  +  \{\frac{n+1}{2+\sqrt{2}}\} = 1,
```

对于所有 $n> 0$，我们赢了，因为这两个非整数的分数部分相加等于整数 $n + 1$。这便是一个划分。

## 3.3 FLOOR/CEILING RECURRENCES
地板和天花板为研究增添了有趣的新维度关于递归关系。让我们首先看看递归
```math
\begin{aligned}
K_0 &= 1; \\
K_{n+1} &= 1 + min(2K_{\lfloor n/2\rfloor}, 3K_{\lfloor n/3\rfloor}), for\ n\ge 0. \tag{3.14}
\end{aligned}
```

因此，例如，$K_1$ 是 $1 + min(2K_0, 3K_0) = 3$；该序列以 $1, 3, 3, 4, 7, 7, 7, 9, 9, 10, 13,\cdots$ 开始。 。本书作者之一谦虚地决定将这些称为克努斯数。

习题 25 要求证明或证伪：对所有 $n\ge 0$，有 $K_n​\ge n$。上面列出的前几项 $K$ 确实满足该不等式，因此这个命题很有可能在一般情形下也成立。我们尝试用数学归纳法证明：归纳基础：$n=0$ 的情形可直接由定义递推式得出。归纳步骤：假设不等式对不超过某个固定非负整数 $n$ 的所有值都成立，我们来证明 $K_{n+1}​\ge {n+1}$。由递推式可知：$K_{n+1}= 1 + min(2K_{\lfloor n/2\rfloor}, 3K_{\lfloor n/3\rfloor})$。归纳假设告诉我们：$2K_{\lfloor n/2\rfloor}​\ge 2\lfloor n/2\rfloor,3K_{\lfloor n/3\rfloor}​\ge 3\lfloor n/3\rfloor$，然而，$2\lfloor n/2\rfloor$ 最小可以取到 $n−1$，$3\lfloor n/3\rfloor$ 最小可以取到 $n−2$。由归纳假设我们最多只能推出：$K_{n+1}\ge 1+(n−2)$ 这与需要证明的 $K_{n+1​}\ge n+1$ 相差甚远。

现在我们有理由对 $K_n​\ge n$ 这一命题的正确性产生怀疑，因此不妨尝试证伪它。如果我们能找到某个正整数 $n$，使得 $2K_{\lfloor n/2\rfloor}​<n$ 或 $3K_{\lfloor n/3\rfloor}​<n$ 成立，换言之，只要找到满足
```math
K_{\lfloor n/2\rfloor}​<n/2\ or\ K_{\lfloor n/3\rfloor} < n/3,
```

那么就会有 $K_{n+1​}<n+1$。这是否真的可能发生？我们最好先不在这里揭晓答案，否则会破坏习题 25 的解题乐趣。

包含下取整与 / 或上取整的递推关系在计算机科学中十分常见，因为基于分治法（divide and conquer） 这一重要技术的算法，通常会把规模为 $n$ 的问题，归约为若干个规模是 $n$ 的分数倍、且规模为整数的同类子问题来求解。例如，当 $n>1$ 时，对 $n$ 条记录进行排序的一种方法是：将它们分成大小近似相等的两部分，一部分规模为 $\lfloor n/2\rfloor$，另一部分规模为 $\lceil n/2\rceil$。顺便提一句，请注意：
```math
n = \lfloor n/2\rfloor + \lceil n/2\rceil; \tag{3.17}
```

这个公式其实非常实用，还经常派上用场。当两部分各自完成排序后（采用相同的方法递归实现），我们只需再进行至多 $n−1$ 次比较，就能将这些记录合并为最终的有序序列。因此，整个排序过程执行的总比较次数至多为 $f(n)$，其中
```math
\begin{aligned}
f(0) &= 0; \\
f(n) &= f(\lfloor n/2\rfloor) + f(\lceil n/2\rceil), for\ n> 1. \tag{3.18}
\end{aligned}
```
该递推式的解法见习题 34

第 1 章的约瑟夫问题也存在一个相似的递推关系，该递推关系可表示为如下形式：
```math
\begin{aligned}
J(1) &= 1; \\
J(n) &= 2J(\lfloor n/2\rfloor) - (-1)^n, for\ n> 1.
\end{aligned}
```

如今我们掌握的解题工具，已经比第 1 章时丰富多了；因此我们来研究更贴合原题原型的约瑟夫问题 —— 此次是每第三个人被淘汰，而非原先的每第二个人。若我们将第 1 章中奏效的方法套用到这个更复杂的问题上，最终会得到形如这样的递推关系：
```math
J_3(n) = \lceil\frac{3}{2}J_3(\lfloor \frac{2}{3}n\rfloor)+a_n \rceil \mod n+1
```

其中 $mod$ 为我们即将展开研究的模函数；参数 $a$ 的取值为 $−2, +1$ 或 $1/2$，具体取决于 $n\mod 3$ 的结果是 0、1 还是 2。但这个递推式过于复杂，根本无从继续深究。

研究约瑟夫问题还有另一种方法，能构建出远更简洁的分析框架。每当有一个人被跳过时，我们就为其分配一个新编号：$1$ 号和 $2$ 号被重新编号为 $n+1$ 号和 $n+2$ 号，随后 $3$ 号被淘汰；$4$ 号和 $5$ 号被重新编号为 $n+3$ 号和 $n+4$ 号，随后 $6$ 号被淘汰；$\cdots 3k+1$ 号和 $3k+2$ 号被重新编号为 $n+2k+1$ 号和 $n+2k+2$ 号，随后 $3k+3$ 号被淘汰；$\cdots$ 最终 $3n$ 号要么被淘汰，要么留至最后存活。 例如，当 $n=10$ 时，各位置的编号对应关系如下：
1 | 2| 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10
| --: | --: | --: | --: | --: | --: | --: | --: | --: | --: |
11 | 12 |  | 13 | 14 |  | 15 | 16 |  | 17
18 | |  | 19 | 20 |  |  | 21 |  | 22
 | |  | 23 | 24 |  |  |  |  | 25
 | |  | 26 |  |  |  |  |  | 27
 | |  | 28 |  |  |  |  |  |
 | |  | 29 |  |  |  |  |  |
 | |  | 30 |  |  |  |  |  |
第 $k$ 个被淘汰的人，最终被分配的新编号为 $3k$。因此，只要我们能求出新编号为 $3n$ 的人对应的原始编号，就能确定最终的存活者。

若新编号 $N>n$，则新编号为 $N$ 的人必然对应一个原始编号，我们可按如下方法求出该原始编号：新编号满足 $N=n+2k+1$ 或 $N=n+2k+2$，因此 $k=\lfloor(N−n−1)/2\rfloor$；对应的原始编号则分别为 $3k+1$ 和 $3k+2$。换言之，原始编号可化简为 $3k+(N−n−2k)=k+N−n$。因此，我们可按如下方式计算每 3 人淘汰的约瑟夫问题中存活者的编号 $J_3​(n)$：
```math
N := 3n; \\
while\ N>n do\ N:=\lfloor\frac{N-n-1}{2}\rfloor + N - n; \\
J_3(n) := n.
```
这并非 $J_3​(n)$ 的闭式解，甚至都算不上一个递推式。但至少它告诉我们，当 $n$ 很大时，如何高效地计算出答案。

所幸，若引入变量 $D=3n+1−N$ 替代 $N$，我们就能找到简化该算法的方法。（这一记法的变更，等价于将编号从 $3n$ 倒序分配至 $1$，而非原先的从 $1$ 正序分配至 $3n$；这有点类似倒计时的方式。）如此一来，原本针对 $N$ 的复杂赋值操作，就简化为：
```math
\begin{aligned}
D :&= 3n + 1 - (\lfloor\frac{(3n+1-D)-n-1}{2}\rfloor + (3n+1-D) - n) \\
   &= n + D - \lfloor\frac{2n-D}{2}\rfloor = D - \lfloor\frac{-D}{2}\rfloor = D + \lceil\frac{D}{2}\rceil = \lceil\frac{3}{2}D\rceil
\end{aligned}
```
由此，我们可将该算法重写如下：
```math
D := 1; \\
while\ D\le 2n do\ D:=\lfloor\frac{3}{2}D\rfloor; \\
J_3(n) := 3n + 1 - D.
```

这样的形式就简洁多了，因为 $n$ 在计算中的参与方式变得极为简洁。事实上，我们可通过完全相同的推导思路证明：当每第 $q$ 个人被淘汰时，存活者的编号 $J_q​(n)$ 可按如下方法计算：
```math
\begin{aligned}
&D := 1; \\
&while\ D\le (q-1)n do\ D:=\lfloor\frac{q}{q-1}D\rfloor; \\
&J_q(n) := qn + 1 - D. \tag{3.19}
\end{aligned} 
```

对于我们熟知的 $q=2$ 的情形，结合约瑟夫问题的经典形式 $n=2^m+l$，代入上述通用方法后可得 $D$ 最终取值为 $2^m+l$；因此推导得：$J_2​(n)=2(2^m+l)+1−(2^{m+l})=2l+1$。

式 (3.19) 中的计算法则可求出一个整数序列，该序列亦可由下述递推式定义：
极简批注版（书页标注）
```math
\begin{aligned}
&D_0^{(q)} = 1; \\
&D_n^{(q)} :=  \lceil\frac{q}{q-1}D_{n-1}^{(q)}\rceil for\ n > 0 \tag{3.20}
\end{aligned} 
```

除 $q=2$ 的情形外，这些数似乎无法以简洁的方式与任何常见函数建立关联；因此这类数大概率不存在简洁的闭式解。但倘若我们愿意将序列 $D_n^{(q)}$ 视作「已知序列」，那么广义约瑟夫问题的解就极易描述：存活者的编号 $J_q​(n)$ 满足 $J_q​(n)=qn+1−D_k^{(q)}$ ​其中 $k$ 为满足 $D_k^{(q)}​>(q−1)n$ 的最小正整数。


