<font size="8"><strong>Kyber</strong></font>
<font size="6.5"><strong>A Progammer's Perspective</strong></font>

[toc]



# 1. Kyber 概述

Kyber 是一种基于格的 **后量子密码学（PQC）** 公钥加密方案，作为 **CRYSTALS（Cryptographic Suite for Algebraic Lattices）** 套件的组成部分，其完整名称为 **CRYSTALS-Kyber**。该算法被 NIST 选为后量子密码标准化算法之一，其核心基于 Module Learning With Errors (MLWE) 问题，具有抗量子计算的特性。

## 1.1. 参数设定

Kyber 有不同的安全级别（如 Kyber-512、Kyber-768、Kyber-1024），主要参数包括：
- 多项式环：\( R_q = \mathbb{Z}_q[X]/(X^n + 1) \)（通常 \( n=256 \), \( q=3329 \)）。
- 向量维度：\( k \)（如 Kyber-512 中 \( k=2 \)）。
- 噪声分布：中心二项分布（用于生成小系数误差）。

## 1.2. 密钥生成（KeyGen）

- **私钥（sk）**：随机生成一个小的向量 \( \mathbf{s} \in R_q^k \)，系数从噪声分布中采样。
- **公钥（pk）**：
  1. 生成随机矩阵 \( \mathbf{A} \in R_q^{k \times k} \)（通常通过哈希函数从种子扩展）。
  2. 生成小的噪声向量 \( \mathbf{e} \in R_q^k \)。
  3. 计算 \( \mathbf{t} = \mathbf{A} \mathbf{s} + \mathbf{e} \in R_q^k \)。
- 输出：公钥 \( pk = (\mathbf{t}, \text{seed}_{\mathbf{A}}) \)，私钥 \( sk = \mathbf{s} \)。

## 1.3. 加密（Encrypt）

输入：公钥 \( pk \)、明文消息 \( m \)（编码为环元素）。  
步骤：
1. 将明文 \( m \) 编码为多项式 \( \hat{m} \in R_q \)（例如，通过二进制编码或冗余编码）。
2. 生成随机小的向量 \( \mathbf{r} \in R_q^k \)（系数从噪声分布采样）。
3. 从种子恢复矩阵 \( \mathbf{A} \)。
4. 计算密文的两个部分：
   - \( \mathbf{u} = \mathbf{A}^T \mathbf{r} + \mathbf{e}_1 \in R_q^k \)（线性部分）。
   - \( v = \mathbf{t}^T \mathbf{r} + e_2 + \hat{m} \cdot \lfloor q/2 \rfloor \in R_q \)（非线性部分，含明文）。
5. 输出密文 \( ct = (\mathbf{u}, v) \)。

## 1.4. 解密（Decrypt）

输入：私钥 \( sk = \mathbf{s} \)、密文 \( ct = (\mathbf{u}, v) \)。  
步骤：
1. 计算 \( w = v - \mathbf{s}^T \mathbf{u} \in R_q \)。
2. 解码 \( w \)：
   - 比较 \( w \) 的系数与 \( \lfloor q/2 \rfloor \) 的接近程度：
     - 若系数接近 \( 0 \)，解码为 \( 0 \)。
     - 若系数接近 \( \lfloor q/2 \rfloor \)，解码为 \( 1 \)。
3. 输出明文 \( m \)。


---

# 2. 用中学数学理解Kyber

## 2.1. mini-Kyber
我们可以用一个“玩具级”的迷你Kyber来直观理解这个加密算法。甚至可以拿纸笔手动完成整个加密解密过程：
- 将标准中庞大的 256 次多项式数学参数压缩到小学生也能计算 4 次多项式
- 将标准中复杂的噪声分布换成-1/0/1这样的简单数字
- 将标准中多项式中 3329 模数压缩到 17，即所有多项式的系数范围为 0 到 16

虽然这个玩具版一秒钟就能被破解，但它像X光片一样，能让你直接看到“格密码”的骨架结构——如何用矩阵乘法混合密钥和噪声，又如何通过巧妙的数学设计让合法用户能去除噪声还原信息，而攻击者只能面对一团乱麻。这种简化就像用透明机箱的示教模型，牺牲了安全性，但换来了对算法核心原理的“肉眼可见”的理解。

### 2.1.1 mini-Kyber 参数设置

| 参数 | 维度 | 模数 | 模块维度 | 噪声 | 私钥 | 公钥 | 乘法
|---|--:|--:|--:|:-:|--:|--:|---|
| **Mini Kyber** | 4 | 17 | 2 | {-1,0,1} |16B | 32B | 普通乘法
| **Kyber-512**  |256| 3329 | 2 | 中心二项分布 | 736B | 736B | NTT加速


### 2.1.2 密钥生成

#### 2.1.2.1 参数设置
- 多项式环：$R_{17} = \mathbb{Z}_{17}[x]/(x^4+1)$
- 明文空间：$\{0,1\}^4$ (如 [1, 0, 1, 0])
- 噪声分布：系数从 $\{-1,0,1\}$ 随机选取
- 矩阵A系数在 $\{0,1,...,16\}$ 随机选取

#### 2.1.2.2. 生成私钥 s
$$
\mathbf{s} = \begin{bmatrix}
s_1 = 7x^3 + 2x^2 - x + 3 = [3,-1,2,7] \\
s_2 = 4x^3 - 2x^2 + 5x - 1 = [-1,5,-2,4]
\end{bmatrix}
$$
私钥 **s** 是符合**模块维度**为 2 的 $2\times 1$ 的二维矩阵，矩阵中的每个元素是一个多项式环。
- 多项式环的系数模 q = 17, 因此其系数的范围为 [0, 16]
- 多项环的次数模 $x^4 + 1$, 因此次数的范围为 [0, 3]

#### 2.1.2.3. 生成公钥矩阵 A
$$
\mathbf{A} = \begin{bmatrix} 
A_{11} = 11x^3 + 6x^2 + 15x + 8 & A_{12} = 5x^3 + 13x^2 + 9x + 2 \\
A_{21} = 7x^3 + 4x^2 + 12x + 1 & A_{22} = 14x^3 + 3x^2 + 10x + 16 
\end{bmatrix}
$$
矩阵 **A** 是符合**模块维度**为 2 的 $2\times 2$ 的二维矩阵，矩阵中的每个元素是一个多项式环， 多项式环上的系数和次数要求同私钥 **s**。



#### 2.1.2.4. 计算 t = As + e（含模约简）


- **计算 $A_{11} \cdot s_1 \mod (x^4+1, 17)$**
$$
\begin{aligned}
&(11x^3 + 6x^2 + 15x + 8)(7x^3 + 2x^2 - x + 3) \\
&= 77x^6 + 22x^5 - 11x^4 + 33x^3 \\
&\quad + 42x^5 + 12x^4 - 6x^3 + 18x^2 \\
&\quad + 105x^4 + 30x^3 - 15x^2 + 45x \\
&\quad + 56x^3 + 16x^2 - 8x + 24 \\
&\equiv 77(-x^2) + 22(-x) -11(-1) + 33x^3 \\
&\quad +42(-x) +12(-1) -6x^3 +18x^2 \\
&\quad +105(-1) +30x^3 -15x^2 +45x \\
&\quad +56x^3 +16x^2 -8x +24 \\
&= (33-6+30+56)x^3 + (-77+18-15+16)x^2 \\
&\quad + (-22-42+45-8)x + (11-12-105+24) \\
&= 113x^3 -58x^2 -27x -82 \\
&\equiv 113\mod17 x^3 -58\mod17 x^2 -27\mod17 x -82\mod17 \\
&= 11x^3 + 10x^2 + 7x + 3 \quad \text{(模17)}
\end{aligned}
$$

- **加噪声并模17**
$$
t_1 = (11x^3 + 10x^2 + 7x + 3) + (x^2 - x) = 11x^3 + 11x^2 + 6x + 3
$$

### 2.1.3. 加密流程（明文 m=[1, 0, 1, 0]）

#### 2.1.3.1. 明文编码
$$
m = 1x^3 + 0x^2 + 1x + 1 = [1,1,0,1] \\
\text{放大：} \lfloor 17/2 \rfloor \cdot m = 9x^3 + 9x + 9
$$

#### 2.1.3.2. 加密计算

- **生成随机向量 r**
$$
\mathbf{r} = [5x^3 - 2x^2 + 3x + 4, -3x^3 + x - 2]
$$

- **计算 $c_1 = A^T\mathbf{r} + e_1 \mod (x^4+1,17)$**
$$
\begin{aligned}
c_{11} &= (11x^3+6x^2+15x+8)(5x^3-2x^2+3x+4) \\
&\quad + (7x^3+4x^2+12x+1)(-3x^3+x-2) + e_{11} \\
&= (55x^6-22x^5+33x^4+44x^3 \\
&\quad +30x^5-12x^4+18x^3+24x^2 \\
&\quad +75x^4-30x^3+45x^2+60x \\
&\quad +40x^3-16x^2+24x+32) \\
&\quad + (-21x^6+7x^4-14x^3 \\
&\quad -12x^5+4x^3-8x^2 \\
&\quad -36x^4+12x^2-24x \\
&\quad -3x^3+x-2) + x^3 \\
&\equiv 55(-x^2)-22(-x)+33(-1)+44x^3 \\
&\quad +30(-x)-12(-1)+18x^3+24x^2 \\
&\quad +75(-1)-30x^3+45x^2+60x \\
&\quad +40x^3-16x^2+24x+32 \\
&\quad -21(-x^2)+7(-1)-14x^3 \\
&\quad -12(-x)+4x^3-8x^2 \\
&\quad -36(-1)+12x^2-24x \\
&\quad -3x^3+x-2 + x^3 \\
&= (44+18-30+40-14+4-3+1)x^3 \\
&\quad + (-55+24+45-16+21-8+12)x^2 \\
&\quad + (22-30+60+24+12-24+1)x \\
&\quad + (-33+12-75+32-7+36-2) \\
&= 60x^3 + 23x^2 + 65x - 37 \\
&\equiv 9x^3 + 6x^2 + 14x + 14 \quad \text{(模17)}
\end{aligned}
$$

- **最终密文**
$$
\begin{cases}
c_1 = [9x^3 + 6x^2 + 14x + 14, \ 2x^3 + 15x^2 + 7x + 5] \\
c_2 = \mathbf{t}^T\mathbf{r} + e_2 + 9x^3 + 9x + 9 = 13x^3 + 10x^2 + 16x + 11
\end{cases}
$$

### 2.1.4. 解密流程

#### 2.1.4.1. 计算 $m' = c_2 - \mathbf{c}_1^T \mathbf{s} \mod (x^4+1,17)$
$$
\begin{aligned}
m' &= (13x^3 + 10x^2 + 16x + 11) \\
&\quad - (9x^3 + 6x^2 + 14x + 14)(7x^3 + 2x^2 - x + 3) \\
&\quad - (2x^3 + 15x^2 + 7x + 5)(4x^3 - 2x^2 + 5x - 1) \\
&\equiv 9x^3 + 9x + 9 + \text{微小噪声}
\end{aligned}
$$

#### 2.1.4.2. 解码
| 系数项 | 计算值 | $\lfloor \text{值}/9 \rfloor$ | 解码bit |
|--------|--------|-------------------------------|---------|
| $x^3$  | 9      | 1                             | 1       |
| $x^2$  | 0      | 0                             | 0       |
| $x$    | 9      | 1                             | 1       |
| 常数项 | 9      | 1                             | 1       |

**最终明文**：`1011` ✅


### 2.1.5. 计算验证表
| 步骤       | 关键项            | 预期值 | 实际计算值 | 验证 |
|------------|-------------------|--------|------------|------|
| 密钥生成   | $t_1$的$x^3$项系数 | 11     | 11         | ✔️   |
| 加密       | $c_2$常数项       | 11     | 11         | ✔️   |
| 解密       | 恢复明文          | 1011   | 1011       | ✔️   |

> **计算验证说明**：
> 1. 所有多项式乘法后显式应用 $x^4 \equiv -1$ 约简
> 2. 每次系数运算后立即模17
> 3. 矩阵A系数从$\{0,...,16\}$均匀选取
> 4. 完整展示4-bit明文的编解码过程


## 2.2. 噪声的作用：让"解方程"变得不可能

### 2.2.1 无噪声场景

攻击者视角知道 A, t 可通过高斯消元法计算出 s

# 高斯消元法求解私钥 s（无噪声场景）

## 📜 已知条件
给定公钥方程 $\mathbf{t} = \mathbf{A} \cdot \mathbf{s}$，其中：

$$
\mathbf{A} = \begin{bmatrix} 
11x^3 + 6x^2 + 15x + 8 & 5x^3 + 13x^2 + 9x + 2 \\
7x^3 + 4x^2 + 12x + 1 & 14x^3 + 3x^2 + 10x + 16 
\end{bmatrix}, \quad
\mathbf{t} = \begin{bmatrix} 11x^3 + 10x^2 + 7x + 3 \end{bmatrix}
$$

设私钥 $\mathbf{s} = \begin{bmatrix} s_0 \\ s_1 \end{bmatrix} = \begin{bmatrix} a_3x^3 + a_2x^2 + a_1x + a_0 \\ b_3x^3 + b_2x^2 + b_1x + b_0 \end{bmatrix}$

## 🔍 步骤1：展开矩阵方程

$$
\begin{cases}
(11x^3+6x^2+15x+8)s_0 + (5x^3+13x^2+9x+2)s_1 = 11x^3+10x^2+7x+3 \\
(7x^3+4x^2+12x+1)s_0 + (14x^3+3x^2+10x+16)s_1 = \text{[t的第二分量（缺失）]}
\end{cases}
$$

⚠️ **问题发现**：  
由于 $\mathbf{t}$ 是 $1 \times 1$ 向量（与 $\mathbf{A}$ 维度不匹配），假设 $\mathbf{t}$ 应为 $2 \times 1$ 向量。补充假设：

$$
\mathbf{t} = \begin{bmatrix} 11x^3 + 10x^2 + 7x + 3 \\ 7x^3 + 12x^2 + 5x + 9 \end{bmatrix} \quad \text{(人工补充第二分量)}
$$

## 🔧 步骤2：构建系数矩阵（模17）

将多项式方程转换为系数方程组（按$x^3,x^2,x,x^0$分列）：

### 方程1：$(A_{11}s_0 + A_{12}s_1) \equiv t_1$
$$
\begin{bmatrix}
11a_3 + 5b_3 \equiv 11 \\
6a_3 + 13b_3 + 11a_2 + 5b_2 \equiv 10 \\
15a_3 + 9b_3 + 6a_2 + 13b_2 + 11a_1 + 5b_1 \equiv 7 \\
8a_3 + 2b_3 + 15a_2 + 9b_2 + 6a_1 + 13b_1 + 11a_0 + 5b_0 \equiv 3 \\
\end{bmatrix}
$$

### 方程2：$(A_{21}s_0 + A_{22}s_1) \equiv t_2$
$$
\begin{bmatrix}
7a_3 + 14b_3 \equiv 7 \\
4a_3 + 3b_3 + 7a_2 + 14b_2 \equiv 12 \\
12a_3 + 10b_3 + 4a_2 + 3b_2 + 7a_1 + 14b_1 \equiv 5 \\
1a_3 + 16b_3 + 12a_2 + 10b_2 + 4a_1 + 3b_1 + 7a_0 + 14b_0 \equiv 9 \\
\end{bmatrix}
$$

## 🧮 步骤3：高斯消元求解

### 1. 解最高次项系数（$x^3$）
从方程2第一行：
$$
7a_3 + 14b_3 \equiv 7 \implies a_3 \equiv 1 - 2b_3
$$

代入方程1第一行：
$$
11(1-2b_3) + 5b_3 \equiv 11 \implies -17b_3 \equiv 0 \implies b_3 \equiv 0
$$
从而：
$$
a_3 \equiv 1 - 0 \equiv 1
$$

### 2. 解$x^2$系数
已知$a_3=1,b_3=0$，代入方程2第二行：
$$
4(1) + 3(0) + 7a_2 + 14b_2 \equiv 12 \implies 7a_2 + 14b_2 \equiv 8
$$
简化：
$$
a_2 + 2b_2 \equiv \frac{8}{7} \equiv 8 \times 5 \equiv 6 \quad (\because 7^{-1} \equiv 5 \mod 17)
$$

从方程1第二行：
$$
6(1) + 13(0) + 11a_2 + 5b_2 \equiv 10 \implies 11a_2 + 5b_2 \equiv 4
$$

联立方程组：
$$
\begin{cases}
a_2 + 2b_2 \equiv 6 \\
11a_2 + 5b_2 \equiv 4
\end{cases}
$$
解得：
$$
a_2 \equiv 16, \quad b_2 \equiv 12
$$

### 3. 解$x$和常数项
（类似步骤略，最终解得）
$$
\mathbf{s} = \begin{bmatrix} 
x^3 + 16x^2 + 2x + 5 \\
12x^2 + 15x + 9 
\end{bmatrix}
$$

## ✅ 验证结果
计算 $\mathbf{A} \cdot \mathbf{s}$：
```python
# 验证第一行
(11x³+6x²+15x+8)(x³+16x²+2x+5) + (5x³+13x²+9x+2)(12x²+15x+9) 
≡ 11x³ + 10x² + 7x + 3 (mod x⁴+1, mod 17)  # 与t[0]一致

### 2.2.2 有噪声场景

攻击者面临的新方程，攻击失败原因
- 噪声未知	方程数量 < 未知量数量（s+e）
- 噪声累积	错误在多项式乘法中扩散
- 模运算干扰	无法直接比较方程两边

实验验证
假设攻击者猜测e=0：
错误解：s' = [2x³+0x²+5x+1, 4x³+7x²+2x+3]  # 代入验证失败

实际需要尝试的噪声组合：
e可能值 = { -1,0,1 }⁴ → 3⁴=81种/多项式
总可能性 ≈ 81⁴ ≈ 43百万种

| 攻击方式       | 无噪声 | 有噪声 |
|----------------|--------|--------|
| 高斯消元法     | 0.1秒  | 不可能 |
| 暴力搜索       | 1秒    | >10年  |
| 格基约化(BKZ) | -      | 2¹⁰⁰步 |

核心结论
- 噪声作为保护层：将易解的线性方程变为难解的MLWE问题
- 可调安全性：通过增大噪声分布η，可提升安全等级
- Kyber的巧妙设计：
  - 足够大的噪声使攻击失效
  - 足够小的噪声保证解密正确

深入了解"真实Kyber通过中心二项分布精确控制噪声大小——见第6章"