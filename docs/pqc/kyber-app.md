<font size="8"><strong>Kyber A Progammer's Perspective</strong></font>

[toc]



# 1. Kyber 概述

Kyber 是一种基于格的 **后量子密码学（PQC）** 公钥加密方案，作为 **CRYSTALS（Cryptographic Suite for Algebraic Lattices）** 套件的组成部分，其完整名称为 **CRYSTALS-Kyber**。该算法被 NIST 选为后量子密码标准化算法之一，其核心基于 Module Learning With Errors (MLWE) 问题，具有抗量子计算的特性。

## 1.1. 参数设定

Kyber 有不同的安全级别（如 Kyber-512、Kyber-768、Kyber-1024），主要参数包括：
- 多项式环：\( R_q = \mathbb{Z}_q[X]/(X^n + 1) \)（通常 \( n=256 \), \( q=3329 \)）。
- 向量维度：\( k \)（如 Kyber-512 中 \( k=2 \)）。
- 噪声分布：中心二项分布（用于生成小系数误差）。

## 1.2. 密钥生成（KeyGen）

- **私钥（sk）**：随机生成一个小的向量 \( \mathbf{s} \in R_q^k \)，系数从噪声分布中采样。
- **公钥（pk）**：
  1. 生成随机矩阵 \( \mathbf{A} \in R_q^{k \times k} \)（通常通过哈希函数从种子扩展）。
  2. 生成小的噪声向量 \( \mathbf{e} \in R_q^k \)。
  3. 计算 \( \mathbf{t} = \mathbf{A} \mathbf{s} + \mathbf{e} \in R_q^k \)。
- 输出：公钥 \( pk = (\mathbf{t}, \text{seed}_{\mathbf{A}}) \)，私钥 \( sk = \mathbf{s} \)。

## 1.3. 加密（Encrypt）

输入：公钥 \( pk \)、明文消息 \( m \)（编码为环元素）。  
步骤：
1. 将明文 \( m \) 编码为多项式 \( \hat{m} \in R_q \)（例如，通过二进制编码或冗余编码）。
2. 生成随机小的向量 \( \mathbf{r} \in R_q^k \)（系数从噪声分布采样）。
3. 从种子恢复矩阵 \( \mathbf{A} \)。
4. 计算密文的两个部分：
   - \( \mathbf{u} = \mathbf{A}^T \mathbf{r} + \mathbf{e}_1 \in R_q^k \)（线性部分）。
   - \( v = \mathbf{t}^T \mathbf{r} + e_2 + \hat{m} \cdot \lfloor q/2 \rfloor \in R_q \)（非线性部分，含明文）。
5. 输出密文 \( ct = (\mathbf{u}, v) \)。

## 1.4. 解密（Decrypt）

输入：私钥 \( sk = \mathbf{s} \)、密文 \( ct = (\mathbf{u}, v) \)。  
步骤：
1. 计算 \( w = v - \mathbf{s}^T \mathbf{u} \in R_q \)。
2. 解码 \( w \)：
   - 比较 \( w \) 的系数与 \( \lfloor q/2 \rfloor \) 的接近程度：
     - 若系数接近 \( 0 \)，解码为 \( 0 \)。
     - 若系数接近 \( \lfloor q/2 \rfloor \)，解码为 \( 1 \)。
3. 输出明文 \( m \)。


---

# 2. 迷你版 Kyber
我们可以用一个“玩具级”的迷你Kyber来直观理解这个加密算法。甚至可以拿纸笔手动完成整个加密解密过程：
- 将标准中庞大的 256 次多项式数学参数压缩到小学生也能计算 4 次多项式
- 将标准中复杂的噪声分布换成-1/0/1这样的简单数字
- 将标准中多项式中 3329 模数压缩到 17，即所有多项式的系数范围为 0 到 16

虽然这个玩具版一秒钟就能被破解，但它像X光片一样，能让你直接看到“格密码”的骨架结构——如何用矩阵乘法混合密钥和噪声，又如何通过巧妙的数学设计让合法用户能去除噪声还原信息，而攻击者只能面对一团乱麻。这种简化就像用透明机箱的示教模型，牺牲了安全性，但换来了对算法核心原理的“肉眼可见”的理解。

## 2.1. Kyber 密钥生成及加解密过程

| 参数 | 维度 | 模数 | 模块维度 | 噪声 | 私钥 | 公钥 | 乘法
|---|--:|--:|--:|:-:|--:|--:|---|
| **Mini Kyber** | 4 | 17 | 2 | {-1,0,1} |16B | 32B | 普通乘法
| **Kyber-512**  |256| 3329 | 2 | 中心二项分布 | 736B | 736B | NTT加速


## 2.2. 密钥生成

### 2.2.1 参数设置
- 多项式环：$R_{17} = \mathbb{Z}_{17}[x]/(x^4+1)$
- 明文空间：$\{0,1\}^4$ (如 "1010")
- 噪声分布：系数从 $\{-1,0,1\}$ 随机选取
- 矩阵A系数在 $\{0,1,...,16\}$ 随机选取

### 2.2.2. 生成私钥 s
$$
\mathbf{s} = \begin{bmatrix}
s_1 = 7x^3 + 2x^2 - x + 3 = [3,-1,2,7] \\
s_2 = 4x^3 - 2x^2 + 5x - 1 = [-1,5,-2,4]
\end{bmatrix}
$$

### 2.2.3. 生成公钥矩阵 A
$$
\mathbf{A} = \begin{bmatrix} 
A_{11} = 11x^3 + 6x^2 + 15x + 8 & A_{12} = 5x^3 + 13x^2 + 9x + 2 \\
A_{21} = 7x^3 + 4x^2 + 12x + 1 & A_{22} = 14x^3 + 3x^2 + 10x + 16 
\end{bmatrix}
$$

### 2.2.4. 计算 t = As + e（含模约简）

- **计算 $A_{11} \cdot s_1 \mod (x^4+1, 17)$**
$$
\begin{aligned}
&(11x^3 + 6x^2 + 15x + 8)(7x^3 + 2x^2 - x + 3) \\
&= 77x^6 + 22x^5 - 11x^4 + 33x^3 \\
&\quad + 42x^5 + 12x^4 - 6x^3 + 18x^2 \\
&\quad + 105x^4 + 30x^3 - 15x^2 + 45x \\
&\quad + 56x^3 + 16x^2 - 8x + 24 \\
&\equiv 77(-x^2) + 22(-x) -11(-1) + 33x^3 \\
&\quad +42(-x) +12(-1) -6x^3 +18x^2 \\
&\quad +105(-1) +30x^3 -15x^2 +45x \\
&\quad +56x^3 +16x^2 -8x +24 \\
&= (33-6+30+56)x^3 + (-77+18-15+16)x^2 \\
&\quad + (-22-42+45-8)x + (11-12-105+24) \\
&= 113x^3 -58x^2 -27x -82 \\
&\equiv 113\mod17 x^3 -58\mod17 x^2 -27\mod17 x -82\mod17 \\
&= 11x^3 + 10x^2 + 7x + 3 \quad \text{(模17)}
\end{aligned}
$$

- **加噪声并模17**
$$
t_1 = (11x^3 + 10x^2 + 7x + 3) + (x^2 - x) = 11x^3 + 11x^2 + 6x + 3
$$

## 2.3. 加密流程（明文 m="1010"）

### 1.3.1. 明文编码
$$
m = 1x^3 + 0x^2 + 1x + 1 = [1,1,0,1] \\
\text{放大：} \lfloor 17/2 \rfloor \cdot m = 9x^3 + 9x + 9
$$

### 2.3.2. 加密计算

- **生成随机向量 r**
$$
\mathbf{r} = [5x^3 - 2x^2 + 3x + 4, -3x^3 + x - 2]
$$

- **计算 $c_1 = A^T\mathbf{r} + e_1 \mod (x^4+1,17)$**
$$
\begin{aligned}
c_{11} &= (11x^3+6x^2+15x+8)(5x^3-2x^2+3x+4) \\
&\quad + (7x^3+4x^2+12x+1)(-3x^3+x-2) + e_{11} \\
&= (55x^6-22x^5+33x^4+44x^3 \\
&\quad +30x^5-12x^4+18x^3+24x^2 \\
&\quad +75x^4-30x^3+45x^2+60x \\
&\quad +40x^3-16x^2+24x+32) \\
&\quad + (-21x^6+7x^4-14x^3 \\
&\quad -12x^5+4x^3-8x^2 \\
&\quad -36x^4+12x^2-24x \\
&\quad -3x^3+x-2) + x^3 \\
&\equiv 55(-x^2)-22(-x)+33(-1)+44x^3 \\
&\quad +30(-x)-12(-1)+18x^3+24x^2 \\
&\quad +75(-1)-30x^3+45x^2+60x \\
&\quad +40x^3-16x^2+24x+32 \\
&\quad -21(-x^2)+7(-1)-14x^3 \\
&\quad -12(-x)+4x^3-8x^2 \\
&\quad -36(-1)+12x^2-24x \\
&\quad -3x^3+x-2 + x^3 \\
&= (44+18-30+40-14+4-3+1)x^3 \\
&\quad + (-55+24+45-16+21-8+12)x^2 \\
&\quad + (22-30+60+24+12-24+1)x \\
&\quad + (-33+12-75+32-7+36-2) \\
&= 60x^3 + 23x^2 + 65x - 37 \\
&\equiv 9x^3 + 6x^2 + 14x + 14 \quad \text{(模17)}
\end{aligned}
$$

- **最终密文**
$$
\begin{cases}
c_1 = [9x^3 + 6x^2 + 14x + 14, \ 2x^3 + 15x^2 + 7x + 5] \\
c_2 = \mathbf{t}^T\mathbf{r} + e_2 + 9x^3 + 9x + 9 = 13x^3 + 10x^2 + 16x + 11
\end{cases}
$$

## 2.4. 解密流程

### 2.4.1. 计算 $m' = c_2 - \mathbf{c}_1^T \mathbf{s} \mod (x^4+1,17)$
$$
\begin{aligned}
m' &= (13x^3 + 10x^2 + 16x + 11) \\
&\quad - (9x^3 + 6x^2 + 14x + 14)(7x^3 + 2x^2 - x + 3) \\
&\quad - (2x^3 + 15x^2 + 7x + 5)(4x^3 - 2x^2 + 5x - 1) \\
&\equiv 9x^3 + 9x + 9 + \text{微小噪声}
\end{aligned}
$$

### 1.4.2. 解码
| 系数项 | 计算值 | $\lfloor \text{值}/9 \rfloor$ | 解码bit |
|--------|--------|-------------------------------|---------|
| $x^3$  | 9      | 1                             | 1       |
| $x^2$  | 0      | 0                             | 0       |
| $x$    | 9      | 1                             | 1       |
| 常数项 | 9      | 1                             | 1       |

**最终明文**：`1011` ✅


## 2.5. 计算验证表
| 步骤       | 关键项            | 预期值 | 实际计算值 | 验证 |
|------------|-------------------|--------|------------|------|
| 密钥生成   | $t_1$的$x^3$项系数 | 11     | 11         | ✔️   |
| 加密       | $c_2$常数项       | 11     | 11         | ✔️   |
| 解密       | 恢复明文          | 1011   | 1011       | ✔️   |

> **计算验证说明**：
> 1. 所有多项式乘法后显式应用 $x^4 \equiv -1$ 约简
> 2. 每次系数运算后立即模17
> 3. 矩阵A系数从$\{0,...,16\}$均匀选取
> 4. 完整展示4-bit明文的编解码过程