class Solution:
    # 同 codeforces 5C
    def longestValidParentheses(self, s: str) -> int:
        # 2022 自行解答，代码比较混乱
        # 当时的思路应是stack留下来的 ”坏“括号数量为关键字，
        # 每段”坏“括号之间的括号数量即为最长的有效括号
        stack = []
        stackLen = 0
        countDict ={}
        cur = 0
        for brack in s:
            if len(stack)>0 and stack[len(stack)-1] == '(' and brack == ')':
                del(stack[-1])
                stackLen -= 1
                if cur > stackLen:
                    prev = countDict[cur]
                    countDict[cur] = 0
                    if stackLen in countDict:
                        countDict[stackLen] = countDict[stackLen] + prev + 2
                    else:
                        countDict[stackLen] = prev + 2
                else:
                    if stackLen in countDict:
                        countDict[stackLen] = countDict[stackLen] + 2
                    else:
                        countDict[stackLen] = 2
                cur = stackLen
            else:
                stack.append(brack)
                stackLen += 1
            # for key in countDict:
            #     longest = max(longest, countDict[key])
        return max(countDict.values())

    
    def longestValidParentheses2(self, s: str) -> int:
        # 参考题解，括号的动态规划 括号DP 模板
        # - 对于 s[i] 为 '(' 其 dp[i] = 0
        # - 对于 s[i] 为 ')',
        #   - 若 s[i-1] 为 '(' 则 dp[i] = dp[i-2]+2
        #   - 若 s[i-1] 为 ')' 若 s[i-dp[i-1]-1]='(' 
        #     则 dp[i] = dp[i-1]+ dp[i-dp[i-1]-2] + 2
        dp = [0] * len(s)
        for i, ch in enumerate(s):
            if ch == ')':
                if i - 1 >= 0:
                    if s[i-1] == '(':
                        dp[i] = 2 + (dp[i-2] if i>1 else 0)
                    if s[i-1] == ')' and i-dp[i-1]-1 >= 0 and s[i-dp[i-1]-1]=='(' :
                        dp[i] = 2 + dp[i-1] + (dp[i-dp[i-1]-2]if i-dp[i-1]-1 > 0 else 0)
        return max(dp) if dp else 0

if __name__ == "__main__":
    sol = Solution()
    print(sol.longestValidParentheses(")()()("))
    # print(sol.longestValidParentheses2(")()()("))
    #print(sol.longestValidParentheses("()()"))
    print(sol.longestValidParentheses("((())())(()))(()()(()(()))(()((((()))))))((()())()))()()(()(((((()()()())))()())(()()))((((((())))((()))()()))))(()))())))()))()())((()()))))(()(((((())))))()((()(()(())((((())(())((()()(()())))())(()(())()()))())(()()()))()(((()())(((()()())))(((()()()))(()()))()))()))))))())()()((()(())(()))()((()()()((())))()(((()())(()))())())))(((()))))())))()(())))()())))())()((()))((()))()))(((())((()()()(()((()((())))((()()))())(()()(()))))())((())))(()))()))))))()(()))())(()())))))(()))((())(()((())(((((()()()(()()())))(()())()((()(()()))(()(())((()((()))))))))(()(())()())()(()(()(()))()()()(()()())))(())(()((((()()))())))(())((()(())())))))())()()))(((())))())((()(()))(()()))((())(())))))(()(()((()((()()))))))(()()()(()()()(()(())()))()))(((()(())()())(()))())))(((()))())(()((()))(()((()()()(())()(()())()(())(()(()((((())()))(((()()(((()())(()()()(())()())())(()(()()((()))))()(()))))(((())))()()))(()))((()))))()()))))((((()(())()()()((()))((()))())())(()((()()())))))))()))(((()))))))(()())))(((()))((()))())))(((()(((())))())(()))))(((()(((((((((((((())(((()))((((())())()))())((((())(((())))())(((()))))()())()(())())(()))))()))()()()))(((((())()()((()))())(()))()()(()()))(())(()()))()))))(((())))))((()()(()()()()((())((((())())))))((((((()((()((())())(()((()))(()())())())(()(())(())(()((())((())))(())())))(()()())((((()))))((()(())(()(()())))))))))((()())()()))((()(((()((()))(((((()()()()()(()(()((()(()))(()(()((()()))))()(()()((((((()((()())()))((())()()(((((()(()))))()()((()())((()())()(())((()))()()(()))"))
    print(sol.longestValidParentheses2("((())())(()))(()()(()(()))(()((((()))))))((()())()))()()(()(((((()()()())))()())(()()))((((((())))((()))()()))))(()))())))()))()())((()()))))(()(((((())))))()((()(()(())((((())(())((()()(()())))())(()(())()()))())(()()()))()(((()())(((()()())))(((()()()))(()()))()))()))))))())()()((()(())(()))()((()()()((())))()(((()())(()))())())))(((()))))())))()(())))()())))())()((()))((()))()))(((())((()()()(()((()((())))((()()))())(()()(()))))())((())))(()))()))))))()(()))())(()())))))(()))((())(()((())(((((()()()(()()())))(()())()((()(()()))(()(())((()((()))))))))(()(())()())()(()(()(()))()()()(()()())))(())(()((((()()))())))(())((()(())())))))())()()))(((())))())((()(()))(()()))((())(())))))(()(()((()((()()))))))(()()()(()()()(()(())()))()))(((()(())()())(()))())))(((()))())(()((()))(()((()()()(())()(()())()(())(()(()((((())()))(((()()(((()())(()()()(())()())())(()(()()((()))))()(()))))(((())))()()))(()))((()))))()()))))((((()(())()()()((()))((()))())())(()((()()())))))))()))(((()))))))(()())))(((()))((()))())))(((()(((())))())(()))))(((()(((((((((((((())(((()))((((())())()))())((((())(((())))())(((()))))()())()(())())(()))))()))()()()))(((((())()()((()))())(()))()()(()()))(())(()()))()))))(((())))))((()()(()()()()((())((((())())))))((((((()((()((())())(()((()))(()())())())(()(())(())(()((())((())))(())())))(()()())((((()))))((()(())(()(()())))))))))((()())()()))((()(((()((()))(((((()()()()()(()(()((()(()))(()(()((()()))))()(()()((((((()((()())()))((())()()(((((()(()))))()()((()())((()())()(())((()))()()(()))"))
